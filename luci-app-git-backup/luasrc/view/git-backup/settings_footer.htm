<script type="text/javascript">
//<![CDATA[

function installDeps() {
	if (!confirm('Install git and wget packages?\n\nThis will run: opkg update && opkg install git wget')) {
		return;
	}

	var btn = event.target;
	btn.disabled = true;
	btn.textContent = 'Installing...';

	var xhr = new XMLHttpRequest();
	xhr.open('POST', '<%=url('admin/system/git-backup/action')%>', true);
	xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');

	xhr.onload = function() {
		if (xhr.status === 200) {
			try {
				var response = JSON.parse(xhr.responseText);
				alert(response.message);
				if (response.success) {
					window.location.reload();
				} else {
					btn.disabled = false;
					btn.textContent = 'Install Dependencies';
				}
			} catch (e) {
				alert('Error: ' + e.message);
				btn.disabled = false;
				btn.textContent = 'Install Dependencies';
			}
		}
	};

	xhr.onerror = function() {
		alert('Network error occurred');
		btn.disabled = false;
		btn.textContent = 'Install Dependencies';
	};

	xhr.send('action=install_deps');
}

function generateKey() {
	if (!confirm('Generate a new SSH key?\n\nThis will create a new ED25519 key pair.')) {
		return;
	}

	var btn = event.target;
	btn.disabled = true;
	btn.textContent = 'Generating...';

	var xhr = new XMLHttpRequest();
	xhr.open('POST', '<%=url('admin/system/git-backup/action')%>', true);
	xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');

	xhr.onload = function() {
		if (xhr.status === 200) {
			try {
				var response = JSON.parse(xhr.responseText);
				alert(response.message);
				if (response.success) {
					window.location.reload();
				} else {
					btn.disabled = false;
					btn.textContent = 'Generate SSH Key';
				}
			} catch (e) {
				alert('Error: ' + e.message);
				btn.disabled = false;
				btn.textContent = 'Generate SSH Key';
			}
		}
	};

	xhr.onerror = function() {
		alert('Network error occurred');
		btn.disabled = false;
		btn.textContent = 'Generate SSH Key';
	};

	xhr.send('action=generate_key');
}

//]]>
</script>

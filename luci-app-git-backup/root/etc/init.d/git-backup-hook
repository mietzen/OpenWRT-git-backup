#!/bin/sh /etc/rc.common
# Git Backup Config Watcher Service
# Auto-detects best method: inotify (event-driven) or polling

START=99
STOP=01

USE_PROCD=1

start_service() {
	# Check if git-backup is enabled
	local enabled=$(uci -q get git-backup.settings.enabled || echo "0")

	if [ "$enabled" != "1" ]; then
		logger -t git-backup-hook "Git backup is disabled, not starting watcher"
		return 0
	fi

	# Start watcher daemon (auto-selects inotify or polling)
	procd_open_instance
	procd_set_param command /usr/lib/git-backup/inotify-watcher.sh
	procd_set_param respawn 3600 5 0  # Respawn after 1 hour, max 5 times, no delay
	procd_set_param stdout 1
	procd_set_param stderr 1
	procd_close_instance

	logger -t git-backup-hook "Started config watcher daemon"
}

stop_service() {
	logger -t git-backup-hook "Stopping config watcher daemon"
	# procd will handle cleanup
}

restart() {
	stop
	start
}

reload_service() {
	restart
}

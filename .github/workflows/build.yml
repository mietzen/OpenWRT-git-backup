name: Build OpenWRT Package

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
    tags:
      - 'v*'

jobs:
  build:
    name: Build IPK Package
    runs-on: ubuntu-latest
    container:
      image: openwrt/sdk:armsr-armv8-openwrt-24.10
      options: --user root

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare SDK and build package
        run: |
          # Find SDK directory (usually /openwrt in the container)
          SDK_DIR=$(find / -maxdepth 2 -name "scripts" -type d -path "*/scripts" 2>/dev/null | grep -E "/(openwrt|sdk)/scripts$" | head -1 | xargs dirname)

          if [ -z "$SDK_DIR" ]; then
            echo "SDK not found, trying common paths..."
            for path in /openwrt /home/build/openwrt /builder /sdk; do
              if [ -d "$path/scripts" ]; then
                SDK_DIR=$path
                break
              fi
            done
          fi

          echo "Using SDK directory: $SDK_DIR"

          # Copy package to SDK
          cp -r luci-app-git-backup $SDK_DIR/package/

          # Update feeds and build
          cd $SDK_DIR
          ./scripts/feeds update -a
          ./scripts/feeds install -a

          # Build the package
          make defconfig
          make package/luci-app-git-backup/compile V=s

          # Save SDK_DIR for next step
          echo "SDK_DIR=$SDK_DIR" >> $GITHUB_ENV

      - name: Find and prepare package
        id: package
        run: |
          cd $SDK_DIR
          PKG_PATH=$(find bin/packages -name "luci-app-git-backup*.ipk" | head -1)
          PKG_NAME=$(basename "$PKG_PATH")

          # Extract version from package name
          VERSION=$(echo "$PKG_NAME" | sed -n 's/luci-app-git-backup_\([0-9.]*\)-[0-9]*_all.ipk/\1/p')

          # Copy to workspace
          cp "$PKG_PATH" "$GITHUB_WORKSPACE/"

          echo "name=$PKG_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # Rename package to include architecture
          NEW_NAME="luci-app-git-backup_${VERSION}_aarch64_generic.ipk"
          cp "$PKG_PATH" "$GITHUB_WORKSPACE/$NEW_NAME"
          echo "renamed=$GITHUB_WORKSPACE/$NEW_NAME" >> $GITHUB_OUTPUT

      - name: Upload package artifact
        uses: actions/upload-artifact@v4
        with:
          name: luci-app-git-backup-aarch64_generic
          path: ${{ steps.package.outputs.renamed }}
          retention-days: 30

      - name: Upload to release
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.package.outputs.version }}
          name: Release v${{ steps.package.outputs.version }}
          draft: false
          prerelease: false
          files: ${{ steps.package.outputs.renamed }}
          body: |
            ## OpenWRT Git Backup v${{ steps.package.outputs.version }}

            ### Installation

            Built for **aarch64_generic** (ARMv8 64-bit devices).

            Install with:
            ```bash
            opkg update
            opkg install luci-app-git-backup_${{ steps.package.outputs.version }}_aarch64_generic.ipk
            ```

            ### Changes

            See commits since last release for details.
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

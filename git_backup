#!/bin/bash
set -eo pipefail

REPO_URL="git@github.com:mietzen/OpenWRT-Backups.git"
SSH_KEY="/root/.ssh/github"
DEVICE_NAME="$(cat /proc/sys/kernel/hostname)"
BRANCH="$DEVICE_NAME"
INTERVAL=300

# Generate SSH key if missing
if [ ! -f "$SSH_KEY" ]; then
    mkdir -p /root/.ssh
    ssh-keygen -t ed25519 -f "$SSH_KEY" -N "" -C "openwrt-backup@$DEVICE_NAME"
    echo "New SSH key generated at $SSH_KEY.pub"
    echo "Add this public key as deploy key to GitHub:"
    cat "$SSH_KEY.pub"
    exit 1
fi

if [ ! -f "/root/.gitconfig" ]; then
    git config --global user.email "backup@openwrt"
    git config --global user.name "OpenWRT Backup"
    git config --global core.sshCommand "ssh -i $SSH_KEY -o StrictHostKeyChecking=accept-new"
fi

if [ ! -d "/.git" ]; then
    git init / &> /dev/null
    git remote add origin "$REPO_URL"
    git switch -c "$BRANCH" 2>/dev/null || git switch "$BRANCH"
    cat << EOF > /.gitignore
/*
/*/
!.gitignore
!/usr/
/usr/*
!/usr/local/
/usr/local/*
!/usr/local/bin/
/usr/local/bin/*
!/usr/local/bin/git_backup
!/root/
/root/*
!/root/.ssh
!/root/.gitconfig
!/etc/
EOF
fi

cd /

# Function to limit git history to MAX_COMMITS
limit_git_history() {
    local MAX_COMMITS=5
    local COMMIT_COUNT=$(git rev-list --count HEAD 2>/dev/null || echo "0")

    if [ "$COMMIT_COUNT" -gt "$MAX_COMMITS" ]; then
        echo "Limiting git history to last $MAX_COMMITS commits (currently: $COMMIT_COUNT)"

        # The commit that will become the new root (5th from HEAD = HEAD~4)
        local NEW_ROOT_INDEX=$((MAX_COMMITS - 1))
        local NEW_ROOT_HASH=$(git rev-parse HEAD~$NEW_ROOT_INDEX)

        # Create an orphan commit with the same tree and message as the 5th commit
        local NEW_ROOT=$(git commit-tree $NEW_ROOT_HASH^{tree} -m "$(git log -1 --format=%B $NEW_ROOT_HASH)")

        # Rebase the remaining commits (HEAD~3 to HEAD) onto this new root
        git rebase --onto $NEW_ROOT $NEW_ROOT_HASH 2>/dev/null || {
            echo "Failed to rebase, aborting history limit"
            git rebase --abort 2>/dev/null
            return 1
        }

        # Force push to update remote with limited history
        git push -f origin "$BRANCH" 2>/dev/null || {
            echo "Failed to force push limited history"
            return 1
        }

        # Clean up unreachable objects to free space
        git reflog expire --expire=now --all 2>/dev/null
        git gc --prune=now --aggressive 2>/dev/null

        echo "Git history limited successfully"
    fi
}

while true; do
    # Commit and push
    git add -A
    if git diff --staged --quiet; then
        echo "No changes to backup"
    else
        git commit -m "Backup $(date -Iseconds)"
        git push -u origin "$BRANCH" -f 2>/dev/null || git push --set-upstream origin "$BRANCH" -f

        # Limit git history after successful push
        limit_git_history
    fi
    sleep $INTERVAL
done

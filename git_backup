#!/bin/bash
set -eo pipefail

REPO_URL="git@github.com:mietzen/OpenWRT-Backups.git"
SSH_KEY="/root/.ssh/github"
DEVICE_NAME="$(cat /proc/sys/kernel/hostname)"
BRANCH="$DEVICE_NAME"
INTERVAL=300

# Generate SSH key if missing
if [ ! -f "$SSH_KEY" ]; then
    mkdir -p /root/.ssh
    ssh-keygen -t ed25519 -f "$SSH_KEY" -N "" -C "openwrt-backup@$DEVICE_NAME"
    echo "New SSH key generated at $SSH_KEY.pub"
    echo "Add this public key as deploy key to GitHub:"
    cat "$SSH_KEY.pub"
    exit 1
fi

if [ ! -f "/root/.gitconfig" ]; then
    git config --global user.email "backup@openwrt"
    git config --global user.name "OpenWRT Backup"
    git config --global core.sshCommand "ssh -i $SSH_KEY -o StrictHostKeyChecking=accept-new"
fi

if [ ! -d "/.git" ]; then
    git init / &> /dev/null
    git remote add origin "$REPO_URL"
    git switch -c "$BRANCH" 2>/dev/null || git switch "$BRANCH"
    cat << EOF > /.gitignore
/*
/*/
!.gitignore
!/usr/
/usr/*
!/usr/local/
/usr/local/*
!/usr/local/bin/
/usr/local/bin/*
!/usr/local/bin/git_backup
!/root/
/root/*
!/root/.ssh
!/root/.gitconfig
!/etc/
EOF
fi

cd /

while true; do
    # Commit and push
    git add -A
    if git diff --staged --quiet; then
        echo "No changes to backup"
    else
        git commit -m "Backup $(date -Iseconds)"
        git push -u origin "$BRANCH" -f 2>/dev/null || git push --set-upstream origin "$BRANCH" -f
    fi
    sleep $INTERVAL
done
